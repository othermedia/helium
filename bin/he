#! /usr/bin/env ruby

home = File.join(File.dirname(__FILE__), '..')

require 'fileutils'
require 'rubygems'
require 'oyster'

require File.join(home, 'lib', 'helium')

spec = Oyster.spec do
  name 'helium -- the Git-backed JavaScript package server'
  author 'James Coglan <jcoglan@googlemail.com>'
  
  description <<-EOS
    Helium is a web application for deploying and serving versioned copies of
    JavaScript libraries from Git repositories. It uses Jake to build libraries
    and extract dependency data that is used to generate a JS.Packages manifest.
  EOS
  
  subcommand :install do
    synopsis 'he install DIRECTORY'
    
    description <<-EOS
      Installs a copy of the Helium web application in the given directory.
      Set up an Apache VHost with the DocumentRoot pointing to DIRECTORY/public
      to serve the app through Phusion Passenger.
    EOS
  end
  
  subcommand :create do
    synopsis 'he create NAME'
    
    description <<-EOS
      Creates a new JavaScript project with the given name, containing a stub
      library file, a jake.yml config file and support code for generating
      local package listings and running tests.
    EOS
  end
end

begin; options = spec.parse
rescue; exit
end

if opts = options[:install]
  dir = opts[:unclaimed].first
  if dir.nil?
    puts "Installation directory required -- type `he install --help` for more info"
    exit
  end
  
  dir = File.expand_path(dir)
  puts "Installing Helium app in #{dir}"
  
  Helium.generate('web', dir)

elsif opts = options[:create]
  name = opts[:unclaimed].first
  if name.nil?
    puts "Project name requires -- type `he create --help` for more info"
    exit
  end
  
  dir = File.expand_path(name)
  puts "Generating JavaScript project in #{dir}"
  puts "Edit your dependencies in jake.yml"
  puts "Change 'example.com' in test/index.html"
  
  Helium.generate('project', dir, :name => name)
end

