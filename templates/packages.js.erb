/**
 * JavaScript package manifest, generated <%= Time.now %>
 * Requires JS.Class package manager: http://jsclass.jcoglan.com/packages.html
 * 
 * Usage: place the following in the HEAD of your HTML pages,
 * then use the `require()` function to load objects on demand.
 * 
 *     <!-- Step 1. Load JS.Class and the package listing -->
 *     <script type="text/javascript">JSCLASS_PATH = 'http://<%= @domain || 'js.example.com' %>/<%= WEB_ROOT %>/js.class/2.1.x/build/min';</script>
 *     <script type="text/javascript" src="http://<%= @domain || 'js.example.com' %>/<%= WEB_ROOT %>/js.class/2.1.x/build/min/loader.js"></script>
 *     <script type="text/javascript" src="http://<%= @domain || 'js.example.com' %>/<%= WEB_ROOT %>/packages.js"></script>
 *     
 *     <!-- Step 2. Declare which branches to use -->
 *     <script type="text/javascript">
 *     Helium.use('yui', '2.7.0');
 *     Helium.use('ojay', '0.4.1');
 *     </script>
 **/
JS.Packages(function() { with(this) {

<% if @custom -%>
/*--- User-defined loader code ---*/
<%= @custom -%>
/*--------------------------------*/
<% end -%>

    var BRANCHES = {}, current, pathname;

<% @tree.each_child do |project, branches| -%>

    BRANCHES['<%= project %>'] = {};
<% branches.each_child do |branch, files| -%>
<% next unless has_manifest?(files) -%>

    current = BRANCHES['<%= project %>']['<%= branch %>'] = {};
<% files.each do |path, config| -%>
<% next unless has_manifest?(config) -%>

    /**
     * Manifest for project '<%= project %>', branch '<%= branch %>'
     * File: '<%= path.first %>'
     **/
    pathname = current['<%= path.first %>'] = {};
    pathname.p = <%= (config[:provides] || []).inspect %>;
    pathname.r = <%= (config[:requires] || []).inspect %>;
    pathname.u = <%= (config[:uses] || []).inspect %>;
<% end -%>
<% end -%>
<% end -%>

    /**
     * log(message) -> undefined
     * - message (String)
     * 
     * Prints configuration notices to the console for debugging
     **/
    var log = function(string) {
        if (!window.console) return;
        console.info ? console.info(string)
                     : console.log(string);
    };
    
    window.Helium = window.Helium || {};
    
<% if @domain -%>
    var protocol = ("https:" == document.location.protocol) ? "https:" : "http:";
    Helium.PATH = protocol + "//<%= @domain %>/<%= WEB_ROOT %>";
<% end -%>
    
    /**
     * Helium.use(project, branch) -> undefined
     * - project (String)
     * - branch (String)
     * 
     * Selects a branch to use from a project, and adds the manifest for the given
     * branch to the JS.Class package registry. This does not load any extra
     * JavaScript files, it simply tells JS.Class which files to use when that
     * project's objects are required.
     * 
     * The Helium.PATH variable *must* be set before calling this function so
     * we can set the full path to the files in the given branch.
     **/
    Helium.use = function(project, branch) {
        if (!this.PATH) throw "Please set Helium.PATH before specifying branches";
        
        var projectBranches = BRANCHES[project];
        if (!projectBranches) throw "Could not find project '" + project + "'";
        
        var pkg = projectBranches[branch];
        if (!pkg) throw "Could not find branch '" + branch + "' of project '" + project + "'";
        
        log("Using '" + project + "', version: '" + branch + "'");
        
        var path, config, builder;
        
        for (path in pkg) {
            if (!pkg.hasOwnProperty(path)) continue;
            
            config  = pkg[path];
            builder = file([this.PATH, project, branch].join('/') + path);
            builder.provides.apply(builder, config.p);
            builder.requires.apply(builder, config.r);
            builder.uses.apply(builder, config.u);
        }
    };

/*--- end JS.Packages block ---*/
}});

