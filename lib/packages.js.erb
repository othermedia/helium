JS.Packages(function() { with(this) {
    var BRANCHES = {}, current, pathname;
    
<% @tree.each_child do |project, branches| %>
    BRANCHES['<%= project %>'] = {};
<% branches.each_child do |branch, files| %>
    current = BRANCHES['<%= project %>']['<%= branch %>'] = {};
<% files.each do |path, config| %>
    pathname = current['/<%= path * '/' %>'] = {};
    pathname.provides = <%= config[:provides].inspect %>;
    pathname.requires = <%= config[:requires].inspect %>;
<% end %>
<% end %>
<% end %>
    
    window.JS_CONFIG = window.JS_CONFIG || {};
    
    JS_CONFIG.use = function(project, branch) {
        if (!this.PATH) throw 'Please set JS_CONFIG.PATH before specifying branches';
        
        var pkg = BRANCHES[project][branch],
            path, config, builder;
        
        for (path in pkg) {
            if (!pkg.hasOwnProperty(path)) continue;
            
            config  = pkg[path];
            builder = file([this.PATH, project, branch].join('/') + path);
            builder.provides.apply(builder, config.provides);
            builder.requires.apply(builder, config.requires);
        }
    };
}});

